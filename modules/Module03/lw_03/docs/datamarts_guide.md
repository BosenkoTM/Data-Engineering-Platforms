# Руководство по формированию аналитических витрин

## Обзор

Данный документ описывает структуру и формирование аналитических витрин для системы управления затратами. Все витрины создаются в схеме `analytics` с префиксом `mart_`.

## Структура витрин

### 1. Витрина для консультантов (`mart_consultant_metrics`)

**Назначение**: Предоставление данных для рекомендаций клиентам по оптимизации затрат.

**Ключевые поля**:
- `strategy_effectiveness` - эффективность стратегий
- `client_recommendation` - рекомендации для клиентов
- `confidence_level` - уровень уверенности в рекомендациях
- `savings_potential` - потенциал экономии
- `risk_level` - уровень риска

**Использование в DataLens**:
- Стрим чарты эффективности стратегий
- Индикаторы уровня риска
- Таблицы рекомендаций

### 2. Витрина для HR и рекрутеров (`mart_hr_recruitment_metrics`)

**Назначение**: Анализ рынка зарплат и планирование бюджета на персонал.

**Ключевые поля**:
- `salary_level` - уровень зарплат
- `training_roi` - ROI от обучения
- `hiring_recommendation` - рекомендации по найму
- `competency_level` - уровень компетенций
- `budget_recommendation` - рекомендации по бюджету

**Использование в DataLens**:
- Стрим чарты зарплатных трендов
- Индикаторы ROI от обучения
- Таблицы компетенций

### 3. Витрина для стратегического планирования (`mart_company_strategy_metrics`)

**Назначение**: Стратегическое планирование и анализ конкурентных преимуществ.

**Ключевые поля**:
- `cost_management_effectiveness` - эффективность управления затратами
- `competitive_advantage` - конкурентные преимущества
- `development_priority` - приоритеты развития
- `investment_priority` - приоритеты инвестиций
- `business_risk` - риски для бизнеса

**Использование в DataLens**:
- Стрим чарты KPI эффективности
- Индикаторы конкурентных преимуществ
- Таблицы приоритетов развития

### 4. Дополнительные витрины

#### `mart_trend_analysis`
- Анализ трендов по месяцам
- Прогнозы на будущие периоды
- Направление трендов (улучшение/ухудшение)

#### `mart_benchmarking`
- Сравнение с отраслевыми стандартами
- Уровень лучших практик
- Рекомендации по улучшению

## Формирование витрин

### Источник данных
Все витрины формируются на основе таблицы `raw_data.cost_survey_results` с использованием агрегатных функций и CASE выражений.

### Логика расчета метрик

#### Эффективность стратегий
```sql
CASE 
    WHEN AVG(cost_deviation) < 0 THEN 'Эффективная'
    WHEN AVG(cost_deviation) BETWEEN 0 AND 10000 THEN 'Умеренно эффективная'
    ELSE 'Неэффективная'
END as strategy_effectiveness
```

#### Уровень риска
```sql
CASE 
    WHEN STDDEV(cost_deviation) > 20000 THEN 'Высокий'
    WHEN STDDEV(cost_deviation) BETWEEN 10000 AND 20000 THEN 'Средний'
    ELSE 'Низкий'
END as risk_level
```

#### Рекомендации для клиентов
```sql
CASE 
    WHEN AVG(cost_deviation) < -5000 THEN 'Рекомендуется к внедрению'
    WHEN AVG(cost_deviation) BETWEEN -5000 AND 0 THEN 'Рассмотреть возможность внедрения'
    WHEN AVG(cost_deviation) BETWEEN 0 AND 10000 THEN 'Требует доработки'
    ELSE 'Не рекомендуется'
END as client_recommendation
```

## DataLens Дашборды

### Дашборд для консультантов

**Источник данных**: `analytics.mart_consultant_metrics`

**3 ключевых графика**:

1. **Стрим чарт "Эффективность стратегий по департаментам"**
   - **Ось X**: `department` (Департамент)
   - **Ось Y**: `avg_cost_deviation` (Среднее отклонение затрат)
   - **Цвет**: `strategy_effectiveness` (Эффективность стратегий)
   - **Размер**: `total_records` (Количество записей)

2. **Индикатор "Уровень риска по категориям затрат"**
   - **Метрика**: `avg_cost_deviation` (Среднее отклонение затрат)
   - **Группировка**: `cost_category` (Категория затрат)
   - **Цвет**: `risk_level` (Уровень риска)

3. **Таблица "Рекомендации для клиентов"**
   - **Поля**: `cost_optimization_strategy`, `client_recommendation`, `confidence_level`, `savings_potential`
   - **Сортировка**: по `avg_cost_deviation` (по возрастанию)

### Дашборд для HR и рекрутеров

**Источник данных**: `analytics.mart_hr_recruitment_metrics`

**3 ключевых графика**:

1. **Стрим чарт "Зарплатные тренды по департаментам"**
   - **Ось X**: `department` (Департамент)
   - **Ось Y**: `avg_cost_per_employee` (Средние затраты на сотрудника)
   - **Цвет**: `salary_level` (Уровень зарплат)
   - **Размер**: `total_records` (Количество записей)

2. **Индикатор "ROI от обучения сотрудников"**
   - **Метрика**: `avg_deviation` (Среднее отклонение)
   - **Группировка**: `cost_category` (Категория затрат)
   - **Цвет**: `training_roi` (ROI от обучения)

3. **Таблица "Компетенции и рекомендации по найму"**
   - **Поля**: `cost_optimization_strategy`, `competency_level`, `hiring_recommendation`, `budget_recommendation`
   - **Сортировка**: по `avg_cost_per_employee` (по убыванию)

### Стратегический дашборд

**Источник данных**: `analytics.mart_company_strategy_metrics`

**3 ключевых графика**:

1. **Стрим чарт "KPI эффективности управления затратами"**
   - **Ось X**: `department` (Департамент)
   - **Ось Y**: `avg_cost_deviation` (Среднее отклонение затрат)
   - **Цвет**: `cost_management_effectiveness` (Эффективность управления)

2. **Индикатор "Конкурентные преимущества"**
   - **Метрика**: `avg_cost_per_employee` (Средние затраты на сотрудника)
   - **Группировка**: `system_category` (Категория системы)
   - **Цвет**: `competitive_advantage` (Конкурентное преимущество)

3. **Таблица "Стратегические приоритеты развития"**
   - **Поля**: `cost_optimization_strategy`, `development_priority`, `strategic_recommendation`
   - **Сортировка**: по `avg_cost_deviation` (по возрастанию)

## Технические детали

### Создание витрин
Витрины создаются автоматически при выполнении скрипта `sql/database_setup.sql` или через Jupyter Notebook `data_analysis.ipynb`.

### Обновление данных
Для обновления витрин используйте функцию `analytics.refresh_datamarts()`.

### Индексы
Все витрины имеют индексы для оптимизации запросов в DataLens.

### Представления
Созданы представления для удобства работы:
- `view_consultant_dashboard`
- `view_hr_dashboard`
- `view_strategy_dashboard`

## Рекомендации по использованию

### Для консультантов
- Используйте стрим чарт для анализа эффективности стратегий по департаментам
- Обращайте внимание на индикатор уровня риска для выявления проблемных областей
- Изучайте таблицу рекомендаций для формирования предложений клиентам

### Для HR и рекрутеров
- Мониторьте стрим чарт зарплатных трендов для планирования бюджета
- Анализируйте индикатор ROI от обучения для оптимизации программ развития
- Используйте таблицу компетенций для планирования найма

### Для стратегического планирования
- Отслеживайте стрим чарт KPI эффективности для оценки результатов
- Анализируйте индикатор конкурентных преимуществ для позиционирования
- Изучайте таблицу приоритетов развития для стратегического планирования

## Контакты

По вопросам использования витрин обращайтесь к команде аналитики.
